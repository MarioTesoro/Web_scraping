function textCount(){var e=stripCombiningMarks($j(this).text());500<e.length?$j(this).text(e.substr(0,500)):($j(this).text().match(regexLineBreakCombiningMarks)||$j(this).text().match(regexSymbolWithCombiningMarks))&&$j(this).text(e)}function validateFrom(e,t,a,n){var o=e.find(t);o.fadeToggle(),n&&o.length&&o.text(n),window.setTimeout(function(){o.fadeToggle(),a.removeAttr("disabled")},3e3)}function ratingThumb(e,t,a,n){$j.post(e,function(e){e&&LocalStorageManager.getInstance().push("commentsRated",e),commentFix(n,a,1)})}function loadAvatar(e){var t=document.querySelector(e),a=t&&t.querySelector(".boxUserComments"),e=a&&a.querySelector("a img.avatarTrigger"),t=e&&e.getAttribute("data-src");e&&t&&e.setAttribute("src",t),a&&MG_Utils.addClass(a,"replyAvatarImg")}function reply(e,t,a){var n=$j(t);$j(".replyBlock").find("button.reply").show().siblings().remove(),n.append('<div class="enterCommentBlock inComments clearfix"><form class="clearfix commentsForm commentReplyForm replyPlaceholder" action="'+e+'" method="post"><div class="textAreaWrap clearfix"><div class="tail"></div><textarea class="commentTextArea comment js_tagTextarea" name="comment" cols="40" rows="3" maxlength="500">'+WIDGET_COMMENTS.commentPlaceholderText+'</textarea></div><div class="actions"><button class="cmtSubmit commentBtn float-right" type="submit"><span>Comment</span></button></div></form></div><div class="feedbackMessages"><p class="error_1 error display-none">'+WIDGET_COMMENTS.error_1+'</p><p class="error_2 error display-none">'+WIDGET_COMMENTS.error_2+'</p><p class="error_3 error display-none">'+WIDGET_COMMENTS.error_3+'</p><p class="error_4 error display-none">'+WIDGET_COMMENTS.error_4+"</p></div>"),n.find(".enterCommentBlock").prepend($j("#userAvatar").html()),n.find("button.reply").hide(),n.show().removeClass("rightMargin float-left"),prepareTagging(),n.find(".js_taggable").text("").trigger("focus"),loadAvatar(t)}function commentDelete(e,t){var a=$j(t),n=a.closest("#cmtWrapper"),o=t.replace(/[^0-9]/g,"");ajaxPost(e,t),a.hide(),$j(".childrenOf"+o).hide(),n.find($j(".childrenOf"+o)).hide(),n.find($j(".showMoreChildren"+o)).hide();o=document.getElementById("tooltip");null!==o&&MG_Utils.addClass(o,"hidden")}function commentSpam(e,t){var a=$j(t),n=a.closest("#cmtWrapper"),o=t.replace(/[^0-9]/g,"");$j.ajax({type:"POST",url:e,success:function(e){e.hasOwnProperty("isSpam")&&!0===e.isSpam&&(LocalStorageManager.getInstance().push("commentsReported",e),a.hide(),$(".childrenOf"+o).hide(),n.find($j(".childrenOf"+o)).hide(),n.find($j(".showMoreChildren"+o)).hide())}})}function commentFix(e,t,a){parseInt(t)?$j(".thumbsUpVote"+e).hasClass("already-voted")||($j(".thumbsUpVote"+e).addClass("already-voted"),a&&$j(".thumbsUpVote"+e).html(parseInt(parseInt($j(".thumbsUpVote"+e).html())+1)),$j(".thumbsDown"+e).hide()):$j(".thumbsDownVote"+e).hasClass("already-voted")||($j(".thumbsDownVote"+e).addClass("already-voted"),a&&$j(".thumbsDownVote"+e).html(parseInt(parseInt($j(".thumbsDownVote"+e).html())+1)),$j(".thumbsUp"+e).hide()),$j(".thumbsUp"+e).attr("disabled",!0),$j(".thumbsDown"+e).attr("disabled",!0),$j("#tooltip").hide()}function commentsRatedUpdate(){var e=LocalStorageManager.getInstance(),e=$j.parseJSON(e.get("commentsRated"));if(!e)return-1;$j.map(e,function(e,t){e=e.split("|");$j(".thumbsUpVote"+t)&&$j(".thumbsDownVote"+t)&&(parseInt($j(".thumbs"+(parseInt(e[0])?"Up":"Down")+"Vote"+t).html())==parseInt(e[1])?commentFix(t,e[0],1):commentFix(t,e[0],0))})}function commentsReportedUpdate(){var e=LocalStorageManager.getInstance(),e=$j.parseJSON(e.get("commentsReported"));if(!e)return-1;$j.map(e,function(e,t){t=t.split("_");$j(".commentTag"+t[1]).remove(),$j(".showMoreChildren"+t[1]).remove(),$j(".childrenOf"+t[1]).remove()})}function placeHolderLoad(){window.setTimeout(function(){$j(".js_taggable").text($j(".js_tagTextarea").val()).addClass("placeHolderText")},250)}function appendInterlanLinks(){$j(".commentMessage").each(function(e,t){var a=$j(this).contents().get(0),a=addInternalLinks(a.nodeValue);$j(this).contents().first().replaceWith(escapeHtml(a))}),initializeCommentThumbs()}function renderLinksInComment(){$j(".commentUsernameLink:not(.processed)").each(function(e,t){var a=$j(this);a.data("href")?a.addClass("processed").html('<a href="'+a.data("href")+'" target="_blank" rel="noopener noreferrer">@'+a.data("username")+"</a>"):a.addClass("processed").html("<span>@"+a.data("username")+"</span>")}),0<$j(".js_taggable").length&&(friendList=[])}function initializeCommentThumbs(){$j(".commentBtn.thumbs").each(function(){var e=$j(this);void 0===$j._data(this,"events")&&e.click(function(){ratingThumb(e.data("ratingurl"),e.data("elem"),e.data("value"),e.data("id"))})})}head.ready(document,function(){var a,e=$j("body");appendInterlanLinks(),e.on("keyup",".js_taggable",textCount),e.on("click",'.commentsForm button[type="submit"]',function(e){e.preventDefault();var n=$j("#commentClone").html(),o=$j(this).closest(".closestComment"),r=$j(this).closest(".enterCommentBlock"),s=$j(this).closest(".enterCommentBlock").next(),l=$j(this).closest(".replyBlock"),i=$j(this),t=$j(this).parents("form"),a=$j(".js_taggable"),e="";i.attr("disabled",!0),0<a.length&&(e=pushCommentData(this)),$j.ajax({type:"POST",url:t.attr("action"),data:0<$j(".chrome, .safari")?("comment="+t[0][0].innerText).replace(/\s/g,"+"):("comment="+e).replace(/\s/g,"+"),success:function(e){var t,a;"PASS"==e.status?(a=(a=(a=(a=(a=(a=(a=(a=(a=(a=n).replace(/\[\[id\]\]/g,e.id)).replace(/\[\[commentMessage\]\]/,addInternalLinks(e.comment))).replace(/\[\[dateAdd\]\]/,"1 second ago")).replace(/\[\[urlDelete\]\]/g,e.deleteLink)).replace(/\[\[urlReply\]\]/g,e.reply)).replace(/\[\[urlSpam\]\]/g,e.spam)).replace(/\[\[urlVoteDown\]\]/g,e.voteDown)).replace(/\[\[urlVoteUp\]\]/g,e.voteUp)).replace(/\[\[dataType\]\]/g,e.type),t=document.getElementById("cmtWrapper"),r.hasClass("mainComment")?t&&MG_Utils.hasClass(t,"videoViewPage")?$j("#cmtContent").prepend(a):$j(".js-cmtInject").after(a):t&&MG_Utils.hasClass(t,"videoViewPage")?o.append(a):o.after(a),o.find(".js_taggable").addClass("placeHolderText").text(WIDGET_COMMENTS.commentPlaceholderText),o.find(".js_tagTextarea").val(WIDGET_COMMENTS.commentPlaceholderText),i.removeAttr("disabled"),""==e.reply&&($j(".commentTag"+e.id+" .replyBlock").remove(),$j(".commentTag"+e.id).addClass("nestedBlock")),0<e.parentId&&$j(".commentTag"+e.id).addClass("childrenOf"+e.parentId),l.find(".enterCommentBlock").remove(),l.find(".reply").removeAttr("style"),renderLinksInComment(),t=document.querySelector("#cmtWrapper .commentsSection"),a=t?t.querySelector(".commentBlock .boxUserComments .avatarTrigger"):null,t="",a&&(t=a.getAttribute("data-src"),a.setAttribute("src",t))):"SPAM"==e.status?validateFrom(s,".error_1",i):"DISABLED"==e.status?validateFrom(s,".error_3",i):"FAIL"==e.status||"EMPTY"==e.status?validateFrom(s,".error_2",i,e.statusMessage):"BANNED_WORDS"==e.status&&validateFrom(s,".error_4",i)}})}),e.on("focus",".js_taggable",function(){window.clearTimeout(a);var e=$j(this);e.closest("form").find('button[type="submit"]').show(),e.addClass("activeEdit"),e.text()==WIDGET_COMMENTS.commentPlaceholderText&&e.text("").removeClass("placeHolderText")}).on("blur",".js_taggable",function(t){a=window.setTimeout(function(){var e=$j(t.target);e.closest("form").find('button[type="submit"]').hide(),e.removeClass("activeEdit"),""==e.text()&&e.text(WIDGET_COMMENTS.commentPlaceholderText).addClass("placeHolderText")},250)}),e.on("focus","textarea.commentTextArea",function(){$j('.commentsForm button[type="submit"]').removeAttr("disabled")}),e.on("blur",".js_taggable",function(){var e=$j(this);e.html(e.html().replace(/<(\bbr\b)>|<(\bp\b)>/gi,"\n")),e.text(e.text().replace(/[\<\>|\[\]|\{\}]/gi,""))}),e.on("click","button.hideElements",function(){var e=$j(this);e.closest(".hiddenParentComments").hide(),$j("#"+e.data("element")).show()}),document.addEventListener("click",function(e){var t,a,n=e.target;MG_Utils.hasClass(n,"commentBtn.loadMore")&&n&&((e=n.getAttribute("data-comment-key"))?(t=document.getElementById(n.getAttribute("data-element")+e))&&MG_Utils.removeClass(t,"display-none"):(t=n.getAttribute("data-page-num"),t=n.getAttribute("data-ajax-url")+"&page="+ ++t,t=t,a=$j(n).parent(),$j.ajax({type:"GET",url:t,data:{isLoadMoreAjax:1},beforeSend:function(){var e=document.createElement("img");e.className="loading",e.src=$j(".js-commentReplacement").data("preload"),a.after(e)},success:function(e){a.siblings("img.loading").remove(),a.after(e),(new LazyLoadImage).init(page_params.lazyLoad)}})),MG_Utils.addClass(n,"display-none"))}),e.on("mouseleave",".cmtDropDown",function(){$j(this).find("ul").hide()}),e.on("click","#js-cmtTriggerMenu",function(){$j(this).next("ul").toggle()}),e.on("click",".js-cmtFilter",function(){var e=$j("#js-cmtTriggerMenu"),t=$j(".js-commentReplacement"),a=$j(this);a.closest("ul").hide(),e.find("span").text(a.find("span").text()),t.toggleClass("active"),$j.ajax({type:"POST",dataType:"html",data:{isSortCommentsAjax:1},url:a.data("sort"),beforeSend:function(){t.addClass("loadingStatus").empty()},success:function(e){t.removeClass("loadingStatus").html(e)},complete:function(){commentsRatedUpdate(),commentsReportedUpdate(),"function"==typeof prepareTagging&&prepareTagging(),placeHolderLoad(),renderLinksInComment(),t.hasClass("active")?$j("#js-cmtTriggerMenu").find("span").html(WIDGET_COMMENTS.recentCommentsText):$j("#js-cmtTriggerMenu").find("span").html(WIDGET_COMMENTS.popularCommentsText);var e=document.querySelectorAll("#cmtWrapper .avatarTrigger");[].forEach.call(e,function(e){e.setAttribute("src",e.getAttribute("data-src"))}),appendInterlanLinks()},error:function(){location.reload()}})}),placeHolderLoad(),commentsRatedUpdate(),commentsReportedUpdate()}),MG_Utils.domReady(function(){document.querySelector(".js-saleVideoLogMessage")&&(e=document.querySelector(".js-saleVideoLogMessage").querySelector("span"),MG_Utils.addEventHandler(e,"click",function(){videoPurchaseFlow.triggerPurchaseFlow()}));var e=document.querySelector(".js-commentLogMessage"),e=e&&e.querySelector("span");e&&e.addEventListener("click",function(){videoPurchaseFlow.triggerPurchaseFlow()});e=document.querySelectorAll("[data-purchase-modal='purchase']");e&&[].forEach.call(e,function(e){e.removeAttribute("disabled"),MG_Utils.addEventHandler(e,"click",function(){videoPurchaseFlow.triggerPurchaseFlow()})}),initializeCommentThumbs()});